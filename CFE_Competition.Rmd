---
title: "CFE_Competition"
subtitle "Blue Team Rules"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(glmnet)
```

```{r config}
train_fp <- "C:/Users/Quinton/Incoming/UCF Dataset 2018 - Training set.csv"		#The filepath of the training data
```

```{r data import}
train <- read_csv(train_fp, col_types = cols(LoanNumber = "d", DownPayment = "d"))
```

```{r data cleaning}
train <- mutate(train, AppReceiveDate = as.Date(AppReceiveDate, format = '%m/%d/%Y'),
  LTV = as.numeric(LTV),
  CoMonthlyLiability = replace(as.numeric(CoMonthlyLiability), is.na(as.numeric(CoMonthlyLiability)), 0),
  CoMonthlyRent = replace(as.numeric(CoMonthlyRent), is.na(as.numeric(CoMonthlyRent)), 0),
  DownPayment = replace(DownPayment, is.na(DownPayment), 0),
  OccupancyStatus = replace(OccupancyStatus, is.na(OccupancyStatus), 'OTHER'),
  isNewVehicle = (isNewVehicle == 'Y'),
  MemberIndicator = (MemberIndicator == 'Y'),
  CoApplicantIndicator = (CoApplicantIndicator == 'Y'),
  IsBalanced = (TotalMonthlyIncome - PrimeMonthlyLiability - CoMonthlyLiability - PrimeMonthlyRent - CoMonthlyRent - EstimatedMonthlyPayment > 0),
  IsBalanced = replace(IsBalanced, is.na(IsBalanced), FALSE),
  NoCredit = (ModifiedCreditScore == 0),
  BadDTI = (DTI < 0.05 | DTI > 0.5 | is.na(DTI)))
```
Note: Many of the numeric variables will not be parsed as numeric due to the way that the data is formatted in the .csv file (ie 100,000 is written as 1.00E+5). Upgrading to the latest version of R will fix this particular issue.

```{r data cleaning part 2}
train_cropped <- train %>% mutate(DTI = replace(DTI, DTI > 2.5 | is.na(DTI), 2.5),
                                  LTV = replace(LTV, LTV > 2.5, 2.5),
                                  LTV = replace(LTV, is.na(LTV), 1),
                                  Lender = Source == 'LENDER',
                                  Consumer = Source == 'CONSUMER',
                                  Employed = EmploymentStatus == 'Employed',
                                  Unemployed = EmploymentStatus == 'Unemployed',
                                  Retired = EmploymentStatus == 'Retired',
                                  TotalEmployedMonths = EmployedMonths + PrevEmployedMonths + CoEmployedMonths + CoPrevEmployedMonths,
                                  Undecided = VehicleMake == 'UNDECIDED',
                                  Homeowner = OccupancyStatus == 'OWN' | OccupancyStatus == 'BUYING',
                                  EstimatedProfit = (EstimatedMonthlyPayment * Loanterm) - AmountRequested,
                                  EstimatedProfit_trans = log(1 +replace(EstimatedProfit, EstimatedProfit < 0, 0))) %>%
  filter(!is.na(EstimatedProfit))
```

```{r data cleaning for regularization}
train_numeric <- train %>%
  filter(!(EstimatedMonthlyPayment * Loanterm - AmountRequested >= 0 & EstimatedMonthlyPayment * Loanterm - AmountRequested < 1)) %>%
  mutate(DTI = replace(DTI, DTI > 2.5, 2.5),
         LTV = replace(LTV, LTV > 2.5, 2.5),
         LTV = replace(LTV, is.na(LTV), 1),
         ModifiedCreditScore_sq = ModifiedCreditScore ** 2,
         ModifiedCreditScore_cu = ModifiedCreditScore ** 3,
         Credit_F = ModifiedCreditScore == 0,
         Credit_D = ModifiedCreditScore >= 400 & ModifiedCreditScore < 630,
         Credit_C = ModifiedCreditScore >= 630 & ModifiedCreditScore < 670,
         Credit_B = ModifiedCreditScore >= 670 & ModifiedCreditScore < 740,
         Credit_A = ModifiedCreditScore >= 740,
         DTI_sq = DTI**2,
         DTI_cu = DTI**3,
         LTV_sq = LTV**2,
         LTV_cu = LTV**3,
         AppReceiveDate = as.numeric(AppReceiveDate) - min(as.numeric(AppReceiveDate)),
         AppReceiveDate_sq = (as.numeric(AppReceiveDate) - min(as.numeric(AppReceiveDate))) ** 2,
         AppReceiveDate_cu = (as.numeric(AppReceiveDate) - min(as.numeric(AppReceiveDate))) ** 3,
         EmployedMonths_log = log(1 + EmployedMonths),
         VehicleMileage_log = log(1 + VehicleMileage),
         TotalVehicleValue_log = log(1 + TotalVehicleValue),
         Lender = as.numeric(Source == 'LENDER'),
         Consumer = as.numeric(Source == 'CONSUMER'),
         Employed = as.numeric(EmploymentStatus == 'Employed'),
         Unemployed = as.numeric(EmploymentStatus == 'Unemployed'),
         Retired = as.numeric(EmploymentStatus == 'Retired'),
         Undecided = as.numeric(VehicleMake == 'UNDECIDED'),
         isNewVehicle = as.numeric(isNewVehicle),
         Homeowner = as.numeric(OccupancyStatus == 'OWN' | OccupancyStatus == 'BUYING'),
         MemberIndicator = as.numeric(MemberIndicator),
         CoApplicantIndicator = as.numeric(CoApplicantIndicator),
         UndecidedLender = Lender * Undecided,
         UndecidedConsumer = Consumer * Undecided,
         EmployedEmployedMonths_log = Employed * log(1 + EmployedMonths),
         UnemployedEmployedMonths_log = Unemployed * log(1 + EmployedMonths),
         RetiredEmployedMonths_log = Retired * log(1 + EmployedMonths),
         HomeownerOccupancyDuration = Homeowner * OccupancyDuration,
         NewUndecidedVehicle = isNewVehicle * Undecided,
         VehicleMileageValue_log = VehicleMileage * log(1 + TotalVehicleValue),
         EstimatedTotalProfit = AmountRequested - EstimatedMonthlyPayment * Loanterm,
         EstimatedTotalProfit_sq = (AmountRequested - EstimatedMonthlyPayment * Loanterm)**2,
         EstimatedTotalProfit_cu = (AmountRequested - EstimatedMonthlyPayment * Loanterm)**3,
         LoanNumber = NULL,
         Source = NULL,
         EmploymentStatus = NULL,
         VehicleMake = NULL,
         OccupancyStatus = NULL,
         RequestType = NULL,
         IsBalanced = NULL,
         BadDTI = NULL) %>% filter(!is.na(Loanterm), !is.na(DTI))
train_elastic_x <- scale(as.matrix(train_numeric %>% select(-'LoanStatus')))
train_elastic_y <- as.factor(train_numeric$LoanStatus)
```

```{r train valid split}
sub_train <- train_cropped %>% sample_frac(.8)
sub_valid <- anti_join(train_cropped, sub_train, by='LoanNumber')
```

```{r loan decider}
LoanDecider_validation <- function(model, data, lower = 0.1, upper = 0.9, estimatedProfitRejection = FALSE) {

	actual <- data$LoanStatus
	probabilities <- 1/(1 + exp(-predict(model, newdata = data)))

	
	decisions <- probabilities %>%
		replace(list = (probabilities > upper), values = "Approved") %>%
		replace(list = (probabilities < lower), values = "Declined") %>%
		replace(list = (probabilities >= lower & probabilities <= upper), values = "No Decision")
	
		if (estimatedProfitRejection == TRUE){
	  decisions <- replace(decisions, data$EstimatedProfit >= 0 & data$EstimatedProfit <= 1, 'Declined')
	}
	
	automation_level <- sum(decisions == 'Approved' | decisions == 'Declined') / length(decisions)
	precision_level <- sum(decisions == 'Approved' & actual == 'Approved') / sum(decisions == 'Approved')
	sensitivity_level <- sum(decisions == 'Approved' & actual == 'Approved') / sum(actual == 'Approved')
	error_rate <- sum((decisions == 'Approved' & actual == 'Declined') | (decisions == 'Declined' & actual == 'Approved')) / sum(decisions == 'Approved' | decisions == 'Declined')

	print(table(actual, decisions))
	cat('Automation Level: ', automation_level, '\n')
	cat('Precision Level: ', precision_level, '\n')
	cat('Sensitivity Level: ', sensitivity_level, '\n')
	cat('Error Rate: ', error_rate, '\n')
}
```
'model' is any logistic regression model using the data set, 'data' is a validation set (a subset of the data we're given), 'lower' is the lower bound of prediction (any loan with an acceptance probability below lower will be rejected), 'upper' is the upper bound of prediction

```{r loan decider sample use}
sub_train <- train %>% sample_frac(.7)
sub_valid <- anti_join(train, sub_train, by='LoanNumber')

model0 <- glm(LoanStatus == 'Approved' ~ IsBalanced, data = sub_train, family = binomial())
LoanDecider_validation(model0, sub_valid)
```

```{r monthly loan approval rate}
monthly_data <- train_cropped %>%
	mutate(AppReceiveMonth = floor_date(AppReceiveDate, unit = 'month')) %>%
	group_by(AppReceiveMonth) %>%
	summarize(ApprovalRate = mean(LoanStatus == 'Approved'))
  mutate(CoMonthlyLiability = replace(CoMonthlyLiability, is.na(CoMonthlyLiability), 0), CoMonthlyRent = replace(CoMonthlyRent, is.na(CoMonthlyRent), 0))

ggplot(monthly_data, mapping = aes(AppReceiveMonth, ApprovalRate)) +
	geom_line() +
	coord_cartesian(ylim = c(0,1), expand = FALSE)
```

```{r make plots}
undecicded_data <- train %>%
  filter(VehicleMake == 'UNDECIDED', VehicleYear < 100)

ggplot(undecicded_data, aes(AppReceiveDate, VehicleYear, color = isNewVehicle)) +
  geom_point()
```

```{r credit/bankruptcy scores vs approval}
ggplot(train, aes(ModifiedCreditScore, ModifiedBankruptcyScore, color = LoanStatus)) + geom_point()
```

```{r income vs approval}
ggplot(train, aes(log(1 + PrimeMonthlyIncome), log(1 + CototalMonthlyIncome), color = LoanStatus)) + geom_point()
```

```{r income/expenses and loan amount vs approval}
singletons <- train %>% filter(CoApplicantIndicator == FALSE)

ggplot(singletons, aes(PrimeMonthlyIncome - PrimeMonthlyLiability - PrimeMonthlyRent - TotalMonthlyDebtBeforeLoan, AmountRequested, color = LoanStatus)) + geom_point() + ylim(0, 150000) + xlim(-100000, 100000)
```

```{r income/expenses/loan amt vs approval, co-applicants}
doubles <- train %>% filter(CoApplicantIndicator == TRUE)

ggplot(doubles, aes(TotalMonthlyIncome - PrimeMonthlyLiability - CoMonthlyLiability - PrimeMonthlyRent - CoMonthlyLiability - TotalMonthlyDebtBeforeLoan, AmountRequested, color = LoanStatus)) + geom_point() + ylim(0, 150000) + xlim(-100000, 100000)
```

```{r loan amount vs vehicle value}
ggplot(train, aes(log(1 + AmountRequested), log(1 + TotalVehicleValue), color = LoanStatus)) + geom_point()
```

```{r vehicle make pivot}
vehicle_make_pivot = train %>%
  group_by(VehicleMake) %>%
  summarize('count' = n(), 'average value' = mean(TotalVehicleValue), 'average mileage' = mean(VehicleMileage), 'member proportion' = mean(MemberIndicator == TRUE), 'acceptance rate' = mean(LoanStatus == 'Approved')) %>%
  filter(count >= 20)

ggplot(vehicle_make_pivot, aes(`average value`, `acceptance rate`, size = count)) + geom_point()
```

```{r trucks}
trucks_only <- train %>%
  filter(VehicleMake == 'CHEVROLET TRUCK' | VehicleMake == 'DODGE TRUCK' | VehicleMake == 'FORD TRUCK') %>%
  mutate(AppReceiveMonth = floor_date(AppReceiveDate, unit = 'month'))

ggplot(trucks_only, aes(AppReceiveMonth, TotalMonthlyIncome - TotalMonthlyDebtBeforeLoan - PrimeMonthlyRent - PrimeMonthlyLiability, color = VehicleMake, shape = LoanStatus)) + geom_point()
```

```{r anomaly analysis}
train_anomaliesByMonth <- train %>%
  filter(!is.na(NumberOfOpenRevolvingAccounts)) %>%
  mutate('AppReceiveMonth' = floor_date(AppReceiveDate, unit = 'month'), 'EstimatedNet' = TotalMonthlyIncome - PrimeMonthlyLiability - CoMonthlyLiability - PrimeMonthlyRent - CoMonthlyRent - TotalMonthlyDebtBeforeLoan - EstimatedMonthlyPayment, 'DenialAnomaly' = (EstimatedNet > 0 & ModifiedCreditScore >= 650 & LoanStatus == 'Declined'), 'ApprovalAnomaly' = ((EstimatedNet <= 0 | ModifiedCreditScore < 650) & LoanStatus == 'Approved')) %>%
  group_by(AppReceiveMonth) %>%
  summarize('Anomalous Approval Rate' = mean(ApprovalAnomaly == TRUE), 'Anomalous Denial Rate' = mean(DenialAnomaly == TRUE))
```

```{r dti ltv}
ggplot(train, aes(LTV, DTI, color = LoanStatus)) +
  geom_point() +
  xlim(0,2) +
  ylim(0,3)
```